# Инфраструктура домашней сети

## СПб

- Роутер Mikrotik
  - [ ] VPN клиент
    - [ ] Перенести настройки с Ульяновска
- ТВ
  - [ ] Корректная работа YouTube

## Ульяновск

- Роутер Mikrotik `RB952Ui-5ac2nD r2`
  - [ ] VPN клиент
    - [ ] Настройка Wireguard
      - [x] 1. Обновить роутер до версии 7.1+
      - [x] 2. Импортировать во вкладке Wireguard конфиг [wg.conf](./configs/wg.conf). Это создаст Interface и Peer
      - [x] 3. Создать Firewall-NAT правило. Видимо это нужно для корректной работы поверх PPoE провайдера https://dzen.ru/a/YlSlHeNcqySLSmCL (https://kiberlis.ru/mikrotik-wireguard-client/)
      - [x] 4. Создать IP-Route с `Dst. Address: 0.0.0.0/0` на `Gateway: wg (созданный на шаге 1)`. Включение/выключение управляет направлением трафика (через vpn или нет)
      - [x] 5. Создать IP-Addresses с Adress из диапазона Wireguard Server с Network из ip-адреса внутреннего ip адреса сервера (не endpoint)
      - [ ] 6. Создать разные таблицы маршрутизации - для обычного соединения и VPN. Иначе, при переключении на VPN кешированные запросы ходят по прежнему маршруту - через провайдера напрямую https://dzen.ru/a/YlSlHeNcqySLSmCL (https://kiberlis.ru/mikrotik-wireguard-client/)
      - [ ] Настроить список маршрутов
      - [ ] Настроить маркирование пакетов
      - [x] Задать MTU 1400 для интерфейсе VPN. Субъективно это существенно подняло скорость
      - [ ] 7. Динамическое переключение канала на VPN, если контент заблокирован
        - [ ] Если прописать подсети ресурсов руками, то их нужно поддерживать, потому что ip'ы меняются
        - [ ] Если подключать списки по BGP, то это очень большое количество маршрутов, которое в итоге упрется в производительность роутера, ведь списки постоянно растут
        - [ ] Если определять заблокированный контент по косвенным признакам, то это облегчит работу системы, но потребуется настройка для каждого провайдера
          - [ ] У провайдера Evo такое поведение
            1. Запрос висит
            2. Отвечает таймаутом
            3. Итог
              1. Можно по таймауту запросы отправлять в vpn: На компе ответ `ERR_EMPTY_RESPONSE`. На телефоне `ERR_CONNECTION_FAILED`
              2. Если запрос вернулся удачно, то добавить его в список на 1 час
              3. Шаг 0: Если запрос есть в списке, то сразу отправить его в vpn
              4. Удалять ip из списка через час (не известно, можно ли так делать в Mikrotik)
            4. Пошел по другому пути
              - [x] 1. Основа добавления ресурсов - Layer7. Заводим правило с регуляркой, в которую прописываем домены. Регулярку пишем такую, чтобы субдомены добавлялись автоматически. На всякие CDN-ы часто выделяют динамические субдомены
              - [x] 2. Заводим mangle, который добавляет в address list BLOCKED ресурс (ip-адрес), который соответствует Layer7 правилу
              - [x] 3. Помечаем connection/route для адресов из address-list BLOCKED и помечаем маршрутом в vpn канал
              - [x] 4. Задать время жизни в формате `24:00:00 dynamic`
              - [ ] 5. Выкачивать список доменов с vpn сервера. Чтобы была возможность раздать его всем роутерам
      - [ ] Особенности и проблемы
        - [x] Distance должен быть одинаковым у PPPoE и Wireguard
        - [ ] tracepath показывает, что одни запросы идут на провайдера, а другие на vpn. например, vk.com идет на vpn, а habr.com идет на провайдера
          - [ ] ...
      - [ ] Собрать настройки в компактный список команд для воспроизведения на других роутерах
  - [x] Обход DPI (каким-либо образом)
    - [x] Пока обхожу через VPN
  - [ ] Блокировка рекламы
    - [ ] Попробовал списки через adlist. Русская реклама никуда не делась
    - [ ] Если реклама блокируется, то посадочные места остаются и их не заблочить через adblock. Какая-то полумера
  - [ ] Поднять клинет для рабочего VPN
    - [x] Поднять стандартный VPN
    - [ ] Поднять резервный VPN
    - [ ] Решить проблему с DNS - хосты не резолвятся в ip адреса. Нужно прописывать статикой
- NAS
  - [ ] Настройка системы
    - [x] 2 x 14TB HDD в зеркале для данных
    - [x] 2 x 1TB SSD в зеркале (или не в зеркале с бекапом системы) для системы и кеша
    - [ ] Возможность подключения стороннего диска для прочтения данных, без форматирования
      - [ ] Вроде можно usb, то пока толком не проверял
      - [ ] Проверить внешний диск
    - [ ] Прогресс
      - [x] Попробовал TOS v5: Мало приложений; Разлогины веб-сессии; Нет возможности ставить linux-приложения из какого-нибудь репозитория с помощью opkg или типа того
      - [x] Попробовал TOS v6: Чуточку лужне центр настроек; Мало приложений; (?) Нет разлогинов веб-сессии; Нет возможности ставить linux-приложения из какого-нибудь репозитория с помощью opkg или типа того; Диски все время шумели, возможно туда писались логи. Возможно можно подключать диски без форматирования, еще не пробовал
      - [x] Нужно попробовать ХРenology. Ожидается: Пакетный менеджер; Больше приложений.
        - [x] Остановился на нем. Использовал ArcLoader и пару из фотографий в интернете
  - [ ] Данные
  - [ ] Бекапы внутренние
    - [ ] Компьютер -> NAS
      - [ ] Скорее NAS <- Компьютер. То есть NAS вытягивает данные с компа для бекапа. Чтобы при смене компа не нужно было почти ничего настраивать, только дать доступ к компу
        - [ ] rsync
          - [ ] Завести отдельного пользователя
          - [ ] Дать пользователю права на чтение всех директорий или только для тех, которые нужны бекапить
  - [ ] Бекапы внешние
    - [ ] Google photo -> NAS
      - [x] Synology Photos. Но приходится запускать приложение на телефоне, чтобы начался бекап
      - [ ] Фоновый бекап 
    - [ ] GitHub -> NAS
    - [ ] NAS -> mail.cloud (webdav)
      - [x] Настроил бекап директорий с NAS в облако
      - [ ] Нужно настроить бекап настроек приложений. Сейчас некоторые приложения вместе с настройками тянут еще и данные (музыка, фото)
  - [x] Синхронизации
    - [x] Google Photo через Synology Photos на телефоне
  - [x] Сервисы
    - [x] Torrent-качалка: Download Station
    - [ ] ~~PLEX~~
      - [ ] Что-то он не хочет корректно работать. Оброс каким-то онлайн функционалом, где там локальные библиотеки даже найти не могу
    - [x] DLNA
    - [x] Библиотека Steam на NFS
      - [x] Ручное монтирование
      - [ ] Авто-монтирование/размонтирование
    - [ ] Steam клиент в docker контейнере для удаленной прямой установки игр в nfs библиотеку
      - [ ] Найти и установить рабочий образ
  - [ ] CasaOS в докер-контейнере для удобного запуска сервисов в докере
    - [x] Потребовалось поменять путь до /usr/bin/docker
    - [x] Потребовалось на хосте слинкковать директорию /DATA до той же, что пробрасывается как /DATA в контейнер CasaOS. Это нужно, потому что связь получается своеобразная - с одной стороны контейнеры внутри casaos контейнера. С другой стороны они на хосте. Поэтому нужно зеркалирование файловой структуры
    - [ ] Скрипт автообновления падает. Нужно найти причину
    - [ ] Пускать трафик через прокси/vpn для некоторых контейнеров (тех, что используют llm)
  - [ ] Виртуальные машины
    - [ ] Настройка
      - [x] Поставил docker контейнер phpvirtualbox, но пока корректно не работает. Кладет сеть
      - [ ] Теперь сеть не кладет, но и сам не работает. Стартует только экран авторизации, дальше какая-то муть с коннектом
    - [ ] Windows для бухгалтерии
    - [ ] Windows для экспериментов и задач
    - [ ] MacOS
  - [ ] Just for fun
    - [ ] Steam Link для игры в браузере
    - [ ] Клиент Steam для удаленной установки на NAS
      - [ ] Пробовал docker-контейнеры steamos и headless-stema, но они не заводятся. Ругаются на faltpack. Завести не удалось.
        - [ ] Но находил 3 команды, которые вроде как должны решить проблему, их не пробовал еще.
        - [ ] Есть еще проблема, что эти докеры хотят проброс X-ов и видеокарты внутрь, а их вроде как нет
      - [ ] Хотел запустить в виртуальной машине
        - [ ] Нативная VMM какая-то странная. Работает только на btrfs, то есть не могу сейчас запустить на ssd. На одном диске можно создать только одно виртуальное окружение, но в нем вроде можно много виртуалок создавать. Папка с самой виртуалкой скрытая, просто так к ней доступ не получить. Какая-то муть там с этими абстракциями и ограничениями. Внтурь виртуалки прокинуть директорию нельзя. То есть для задачи со steam вообще не подходит
        - [ ] virtualbox. Все докеры это просто веб интерфейс к виртуалке. Ее нужно нативно поставить на железо.
          - [ ] Просто так поставить нельзя, потому что пакета подходящего нет.
          - [ ] Хотел сделать chroot и поставить туда. Нужен модуль ядра с заголовками linux-headers. Из коробки зоголовков нет. Пробовал собрать с помощью toolchain. Вроде собрал, но virtualbox их не видит или собралось не то
          - [ ] Изучал можно ли запустить докер с другим ядром (у которого есть заголовки), но вроде как нельзя
            - [ ] Есть контейнеры lxd, они это врое умеют, но делают через qemu. Если они делают черезе него, то может попробовать сразу через qemu?
              - [ ] Пока запустить не удалось
          - [x] Находил реп с нативным пакетом для DSM 6. Почитал исходники, не понял, откуда там берутся модули ядра. Но можно тоже попробовать
            - [x] Модули скомпилировал. Они загружаются, но виртуалка зависает
        - [ ] Попытался запустить в докере virmanager, но он не работает из-за сервиса логирования. Тот не может нормально стартануть
        - [ ] В докере запустил qemu.
          - [ ] Linux со Steam - запускается, авторизуется, но не можеть загрузить user data
          - [ ] Windows со Steam - авторизовался, начал скачивать игру, но видимо не может сохранить ее на диск и упал. При старте снова пытается скачать и падает
  - [ ] Поднять VPN сервер для объединения всех роутеров в локальную сеть
  - [ ] Поменять роутер с 2.5GB+ Ethernet
    - [ ] WiFi 2.4/5GHz
    - [ ] LAN 2.5GB+
  - [ ] Remote development сервер
    - [ ] Запуск удаленных инстансов WebStorm через JetBrains Gateway
    - [ ] Проброс портов для дев-серверов
- ТВ Бокс
  - [x] Корректная работа YouTube
- Прочие клиенты
- Game Statiion
  - [x] Steam Deck
    - [x] Dock Station
    - [ ] External GPU over OCuLink
      - [ ] Adapter m2 https://aliexpress.ru/item/1005006827709738.html
      - [ ] GPU dock station https://market.yandex.ru/product--ocup4v2-oculink-gpu-dock-redriver-chip-support-pci-e-4-0x4-dopolnitelno-nvme-m-2-dlia-adaptera-oculink-vneshniaia-graficheskaia-karta-dlia-noutbuka
      - [ ] PSU SFX https://market.yandex.ru/product--blok-pitaniia-750w-1stplayer-sfx-ps-750sfx/1489407774
      - [x] GPU min RX 6650 XT
      - [x] MicroSD 1TB https://market.yandex.ru/product--sd-karta-sandisk-ultra-sdsquac-1t00-gn6mn/95455943?hid=90401
      - [ ] Steam Deck BackPlate
- HomeLab
  - [ ] Стенд https://anbik.ru/setevye-skafy/item-3092/
  - [ ] Роутер
  - [ ] NAS
  - [ ] ИБП
  - [ ] Патч-панель rj45
  - [ ] Патч-панель прочее (hdmi, usb, кнопки, oculink)
  - [ ] Сетевой фильтр
  - [ ] Разводка сети
  - [ ] Мини ПК для виртуалок, которые не заводятся на NAS
  - [ ] Может быть Micro-ATX/Mini-ITX ПК
  - [ ] Видеокарта для AI и прочего
    - [ ] Подключение oculink для разных потребителей
      - [ ] МиниПК
      - [ ] RaspberryPi
  - [ ] RaspberryPi/BananaPi
  - [ ] Nvidia jetson orin nano super developer kit https://www.nvidia.com/en-us/autonomous-machines/embedded-systems/jetson-orin/nano-super-developer-kit/

## Чудово

- Роутер Mikrotik
  - [ ] VPN клиент
    - [ ] Перенести настройки с Ульяновска
- ПК мамы
  - [ ] Корректная работа YouTube
- Прочие клиенты

## Европа

- VPS
  - [ ] VPN сервер
    - [x] Amnesia (черновой вариант)
    - [x] Сделал чистовой, но не помню как. В итоге получился Wireguard и Amnezia
    - [x] VPN Wireguard server https://habr.com/ru/articles/738408/
      - [x] Настройка Wireguard сервера https://timeweb.cloud/tutorials/network-security/wireguard-na-svoem-servere
        - [x] Настройка локального клиента перед настройкой роутера, для понимания работы с протоколом
          - Локальный конфиг клиента [wg.conf](./configs/wg.conf). Потребуется для настройки роутера
        - `!` После настройки и перезапуска сервиса приконектиться клиентом не получалось. Помогло перезагрузка сервера
        - Пишут, что Wireguard не помогает обойти DPI. Видимо нужно другое решение, но начну с этого
        - Пишут, что OpenVPN очень ресурсоемкий для Miktorik
        - Есть мнение, что наиболее хорошим решением является поднять дополнительный VPS в России, куда идти легковесным протоколом, а дальше уже идти на заграничный серьезный VPN. Но не понятно, как это должно помочь, если трафик то попадет под эвристику. Возможно, внутри страны не будут за этим следить
  - [ ] Поднять прокси для работы экстеншена в браузере
    - [ ] Найти экстеншен
    - [ ] Поднять прокси-сервер
  - [ ] Настройка сервера
    - [x] https://xakep.ru/2022/02/08/vps-server-todo/
    - [ ] Документировние для последующего воспроизведения
  - [x] Установить CasaOS
